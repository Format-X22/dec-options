## 4 ноября 2021

Проект работает поверх NestJS, база данных MongoDB.
Проект работает в режиме Monorepo, имеет 2 разделенных микросервиса.
Микросервисы не общаются между собой.
Микросервис-агрегатор собирает данные, а микросервис-апи - их отдает.
Структура стандартная для NestJS, могут быть нюансы что что-то сгруппировано в папки,
но на этом всё.
Апи-сервис содержит NextJS как фронт, подключается в `apps/aggregation-api/src/view/`.
Также проект содержит в себе и фронтенд в папке `apps/frontend/`.

## Агрегатор
Смотри `apps/options-aggregator/src`, все пути до файлов в доке будут от этой папки.

Из-за ограничений рейт-лимитов сбор данных происходит неспешно. Возможно имеет смысл в будущем
добавить загрузку в несколько потоков с разными IP, как агрегацию самих опционов, так статистики,
которая тоже собирается запросами на биржи.
                                                                  
#### Сама агрегация данных

Точка входа находится в основном сервисе `options-aggregator.service.ts`.
Там определяется какие агрегаторы будут запущены. Все агрегаторы наследуют общий принцип работы у
`options/aggregator.abstract.ts` и, в основном, имплементируют методы шагов агрегации.
Для централизованных бирж используется библиотека ccxt, но ограничено, т.к. для опционов там особо
апи и нет, но для подписи запросов и получения рейт-лимитов удобно. Для децентрализованных бирж
используется thegraph.com, но там содержатся не все данные, поэтому нужны дополнительные запросы.
Для бирж на протоколе 0x используется запрос ещё туда, в зависимости от биржи по-разному, но в целом
принцип работ у них похож.
                         
Некоторые из агрегаторов отключены:

- Hegic не работает и там нужно переосмысление логики т.к. там не ванильные опционы с плавающими датами
  и вообще многими параметрами, агрегатор отключен т.к. не верен, сейчас не подходит для агрегации.
  Также есть подозрение, что вышедшая новая версия ломает совместимость.

- Siren отключен, возможно там уже не актуальная агрегация, либо не полная, необходима доработка.

- Finnexus в виде заглушки, но, судя по прошлым исследованиям, нам подходит.
                                                                                
#### Статистика

Существует также агрегатор статистики, она нужна для отображения в графиках.
Сейчас данные собираются только с централизованных бирж и на сколько это возможно.
Данные собираются ежечасно, собирается - объем, открытый интерес и волатильность (implied volatility).
Бинанс не отдает открытый интерес, как минимум на момент его интеграции, возможно уже начал.

#### Вспомогательное

Существует автоматический клинер, удаляющий старое и лишнее, смотри `cleaner/`.

Также имеется сервис получения данных по ценам на токены и газ, смотри `price/`.
Сервис кеширует цены в базе данных.

## Апи
Смотри `apps/aggregation-api/src`, все пути до файлов в доке будут от этой папки.

Апи-сервис состоит из 2х частей.

- NextJS для рендеринга фронта. Сам же фронт хранится в папке `apps/frontend/` (путь от корня).
  Всё что относится к подключению фронта содержится в папке `view/`.
  Там всё достаточно стандартно и это лишь, по сути, бинд фронта к беку.
                  

- GraphQL резолверы и сервисы для получения данных по опционам, ценам на токены и статистике.
  Смотри `option/`, `price/` и `stats/`.
  Также в папке с логикой по опционам содержится апи по подписке на рассылку писем, но необходимо
  вынести её в отдельный модуль.
  Логика получения данных по опционам содержит три основные части - получение самих опционов, маркетов
  и стаканов (orderbook).
  В запросе на статистику есть фильтр по типу бирж - централизованная и децентрализованная, но
  так как статистика у нас только по централизованным - сейчас там отдаётся всегда одно и то же.

## Модели данных

Также есть шаред-модели, самих данных в базе, резолверов и всякие декларативные описания
типов и интерфейсов. Всё это используется по всему приложению, может использоваться и на фронте.
Содержится в папке `libs/shared/`.
Используется двойной биндинг моделей - класс с полями, которые помечены декораторами, сразу двумя,
и для базы данных, и для GraphQL. Также есть специализированные утилиты и модели для того чтобы
выдавать данные с пагинацией, смотри `libs/shared/src/list.dto.ts`.
